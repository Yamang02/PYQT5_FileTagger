## 개발 요청 명세 (Development Request Specification)

*   **문서 ID**: `DRS-20250719-001`
*   **작성일**: `2025년 7월 19일`
*   **작성자**: `Gemini (PM/PL)`
*   **관련 기능/모듈**: `태그 관리, 파일 검색, 데이터 저장소`
*   **관련 이슈**: `[이슈] 검색 기능 파일 경로 정규화 및 MongoDB 부분일치 검색 문제 (2025-01-15)`

---

### 1. 개요 (Overview)

*   이 개발 요청의 목적은 FileTagger 애플리케이션의 태그 저장 및 검색 아키텍처를 개선하여, 태그 자체의 메타데이터 관리(예: 카테고리, 관계)를 가능하게 하고, 대용량 데이터 환경에서 효율적인 태그 기반 검색 성능을 확보하는 것입니다.
*   현재 태그가 파일 문서 내에 임베딩되어 있어 태그 자체의 속성 관리 및 복잡한 태그 기반 검색에 한계가 있습니다. 또한, 파일 경로 정규화 문제로 인해 검색 기능의 신뢰성이 저하되고 있습니다.
*   이 개선을 통해 사용자에게 더욱 강력하고 유연한 태그 관리 및 검색 경험을 제공하고, 향후 태그 간 관계 설정과 같은 고급 기능을 확장할 수 있는 기반을 마련합니다.

### 2. 요구사항 (Requirements)

*   **2.1. 기능 요구사항 (Functional Requirements)**
    *   **태그 메타데이터 관리:**
        *   시스템은 태그 이름 외에 카테고리, 설명 등 추가 메타데이터를 저장하고 관리할 수 있어야 합니다.
        *   향후 태그 간의 상위/하위/등위 관계를 표현할 수 있는 구조적 유연성을 제공해야 합니다.
    *   **효율적인 태그 기반 검색:**
        *   사용자는 태그 이름(부분 일치 포함) 및 태그 카테고리를 기준으로 파일을 검색할 수 있어야 합니다.
        *   대용량 데이터 환경에서도 검색 성능 저하 없이 빠른 응답 시간을 보장해야 합니다.
    *   **파일 경로 정규화:**
        *   모든 파일 경로는 데이터베이스 저장 및 검색 시 운영체제에 독립적인 단일 형식(슬래시 `/` 구분자)으로 통일되어야 합니다.
        *   UI에서 입력되거나 파일 시스템에서 읽어온 경로도 이 형식으로 자동 변환되어야 합니다.
    *   **기존 태그 부여 기능 유지:**
        *   현재의 '태그 부여' UI/UX는 큰 변경 없이 유지되어야 합니다.
    *   **태그 관계 설정 기능 추가 (향후):**
        *   태그 간의 관계(상위/하위/등위)를 설정하고 관리할 수 있는 별도의 UI가 추가될 수 있는 기반을 마련해야 합니다.
    *   **고급 검색 기능 강화 (향후):**
        *   태그 및 파일 기반 검색 기능을 극대화한 전용 검색 UI가 추가될 수 있는 기반을 마련해야 합니다.

*   **2.2. 비기능 요구사항 (Non-Functional Requirements)**
    *   **성능**: 태그 추가/삭제 및 검색 작업 시 사용자에게 지연이 느껴지지 않는 수준의 응답 시간을 유지해야 합니다. (예: 100,000개 파일, 각 파일당 평균 5개 태그 기준, 검색 응답 시간 1초 이내)
    *   **확장성**: 새로운 태그 속성 추가, 태그 관계 유형 확장, 검색 조건 복잡성 증가에 유연하게 대응할 수 있는 아키텍처를 제공해야 합니다.
    *   **유지보수성**: 코드의 모듈화 및 응집도를 높여 향후 유지보수 및 기능 확장이 용이해야 합니다.
    *   **데이터 일관성**: 태그 데이터와 파일-태그 연결 데이터 간의 일관성을 보장해야 합니다.
    *   **보안**: MongoDB 인증이 필요한 쿼리는 사용하지 않습니다.

### 3. UI/UX 설계 (User Interface / User Experience Design)

*   **기존 '태그 부여' UI 유지:** 현재 `TagControlWidget` 및 관련 UI는 큰 변경 없이 기존 기능을 수행합니다. 내부적으로는 새로운 데이터 모델을 사용하도록 로직이 변경됩니다.
*   **태그 관계 설정 UI (향후):** 별도의 화면 또는 다이얼로그 형태로 구현될 예정이며, 태그 목록을 표시하고 각 태그에 대한 관계(상위, 하위, 등위)를 설정할 수 있는 인터페이스를 제공합니다. (본 DRS에서는 상세 설계 제외)
*   **고급 검색 UI (향후):** 태그, 카테고리, 파일 속성 등을 조합하여 복잡한 검색 쿼리를 생성하고 실행할 수 있는 전용 검색 인터페이스를 제공합니다. (본 DRS에서는 상세 설계 제외)

### 4. 기술적 고려사항 (Technical Considerations)

*   **아키텍처 영향**:
    *   **데이터 모델 변경**:
        *   **`tags` 컬렉션 신설**: 태그 자체의 메타데이터를 저장합니다. 제안하는 기본 스키마는 다음과 같습니다.
            ```json
            {
                "_id": ObjectId,        // MongoDB 기본 ID
                "name": "string",       // 태그 이름 (필수, 고유, 최대 50자)
                "category": "string",   // 태그 카테고리 (선택, 자유 입력, 최대 50자)
                "description": "string",// 태그 설명 (선택, 최대 200자)
                "parent_tags": [ObjectId], // 상위 태그 참조 (향후 확장 고려, 현재는 스키마에 포함하되 사용하지 않음)
                "child_tags": [ObjectId],  // 하위 태그 참조 (향후 확장 고려, 현재는 스키마에 포함하되 사용하지 않음)
                "related_tags": [ObjectId], // 관련 태그 참조 (향후 확장 고려, 현재는 스키마에 포함하되 사용하지 않음)
                "created_at": ISODate,  // 생성일시
                "updated_at": ISODate   // 최종 수정일시
            }
            ```
            *   **태그 이름**: 최대 50자. 고유해야 하며 필수 필드입니다.
            *   **카테고리**: 최대 50자. 사전 정의 목록 없이 자유 입력이 가능합니다.
            *   **태그 설명**: 최대 200자.
            *   **태그 관계 필드 (`parent_tags`, `child_tags`, `related_tags`)**: 현재 구현에서는 사용하지 않지만, 향후 태그 간의 관계 표현 가능성을 고려하여 스키마에 포함합니다. 이 필드들은 `tags` 컬렉션 내의 다른 태그 문서 `_id`를 참조하는 배열 형태입니다.
        *   **`tagged_files` 컬렉션 변경**: `tags` 필드가 태그 이름 배열에서 `tags` 컬렉션의 `_id`를 참조하는 배열로 변경됩니다.
    *   **파일 경로 정규화**:
        *   `core/path_utils.py`의 `normalize_path` 함수를 수정하여 모든 파일 경로를 슬래시(`/`) 기반으로 통일합니다.
        *   `TagRepository` 및 파일 경로를 사용하는 모든 모듈에서 이 정규화된 경로를 사용하도록 강제합니다.
    *   **`TagRepository` 리팩토링**:
        *   `add_tag`, `remove_tag`, `get_tags_for_file`, `get_all_tags`, `get_files_by_tags` 등 모든 메서드의 내부 로직을 새로운 데이터 모델에 맞춰 재구현합니다.
        *   특히 `get_files_by_tags` 및 기타 검색 관련 메서드에서는 MongoDB의 `$lookup` 연산자를 활용하여 `tags` 컬렉션과의 조인 기능을 구현합니다.
        *   태그 이름으로 태그 `_id`를 조회하거나, 태그 `_id`로 태그 이름을 조회하는 헬퍼 메서드를 추가합니다.
    *   **`TagService` 및 `TagManager` 리팩토링**:
        *   `TagRepository`의 변경된 인터페이스에 맞춰 상위 계층의 로직을 수정합니다.
        *   UI 계층으로 태그 정보를 전달할 때, 태그 이름뿐만 아니라 카테고리 등 필요한 메타데이터를 포함하도록 데이터 구조를 변경할 수 있습니다.
    *   **`SearchManager` 리팩토링**:
        *   태그 컬렉션의 텍스트 인덱스 또는 정규식 쿼리를 활용하여 효율적인 부분일치 검색을 구현합니다.
        *   파일 시스템 순회 로직과 DB 검색 로직을 명확히 분리하고, 통합된 검색 결과를 제공합니다.

*   **데이터 마이그레이션**:
    *   현재 개발 단계이므로 기존 데이터 마이그레이션은 수행하지 않으며, 새로운 스키마에 맞춰 DB를 초기화하고 사용합니다.

*   **성능 최적화**:
    *   MongoDB 인덱스 전략을 재검토하고, 필요한 인덱스(예: `tags` 컬렉션의 `name` 필드에 대한 텍스트 인덱스, `tagged_files` 컬렉션의 `file_path` 및 `tags` 필드에 대한 인덱스)를 추가합니다.
    *   복잡한 쿼리 시 애그리게이션 파이프라인(`$lookup`, `$match`, `$project` 등)을 효율적으로 사용합니다.

*   **재사용 가능한 컴포넌트**:
    *   태그 관련 데이터 모델 및 유틸리티 함수를 `models` 또는 `core/utils`와 같은 공통 모듈로 분리하여 재사용성을 높입니다.

### 5. 테스트 시나리오 (Test Scenarios)

*   **파일 경로 정규화 테스트**:
    *   Windows 및 Linux 스타일 경로가 모두 슬래시(`/`)로 올바르게 정규화되는지 확인합니다.
    *   정규화된 경로가 DB에 저장되고 검색 시 올바르게 사용되는지 확인합니다.
*   **태그 컬렉션 CRUD 테스트**:
    *   새로운 `tags` 컬렉션에 태그가 올바르게 추가, 조회, 수정, 삭제되는지 확인합니다.
    *   태그의 메타데이터(카테고리 등)가 올바르게 저장되고 조회되는지 확인합니다.
*   **파일-태그 연결 테스트**:
    *   파일에 태그 추가 시 `tags` 컬렉션의 `_id`가 `tagged_files`에 올바르게 참조되는지 확인합니다.
    *   파일에서 태그 제거 시 `tagged_files`에서 `_id` 참조가 올바르게 제거되는지 확인합니다.
    *   파일의 태그 조회 시 `tags` 컬렉션의 메타데이터와 함께 올바른 태그 정보가 반환되는지 확인합니다.
*   **태그 기반 검색 테스트**:
    *   단일 태그 이름으로 파일 검색 시 올바른 결과가 반환되는지 확인합니다.
    *   여러 태그 이름(AND/OR 조건)으로 파일 검색 시 올바른 결과가 반환되는지 확인합니다.
    *   태그 이름의 부분 일치 검색 시 올바른 결과가 반환되는지 확인합니다.
    *   태그 카테고리를 기준으로 파일 검색 시 올바른 결과가 반환되는지 확인합니다.
    *   대량 데이터 환경에서 검색 성능을 측정하고 목표 성능을 달성하는지 확인합니다.
*   **UI 연동 테스트**:
    *   기존 '태그 부여' UI에서 태그 추가/삭제 시 내부적으로 새로운 아키텍처가 올바르게 동작하는지 확인합니다.
    *   태그 관계 설정 및 고급 검색 UI (향후 구현 시)가 새로운 아키텍처와 올바르게 연동되는지 확인합니다.

### 6. 기타 (Miscellaneous)

*   이 DRS는 태그 아키텍처의 근본적인 변경을 다루며, 향후 태그 관계 설정 및 고급 검색 기능 확장의 기반이 됩니다.
*   개발팀은 이 DRS를 바탕으로 상세 설계 및 구현 계획을 수립해야 합니다.
*   MongoDB 인증이 필요한 쿼리는 사용하지 않는다는 원칙을 준수합니다.
